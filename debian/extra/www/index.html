<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>SVX Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0b0f14;--fg:#e6edf3;--muted:#8b949e;--ok:#2ea043;--bad:#f85149;--warn:#d29922;--card:#0f1720;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;}
  header{padding:12px 16px;border-bottom:1px solid #1f2630;background:#0d131b;position:sticky;top:0}
  header h1{margin:0;font-size:16px}
  main{padding:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid #1f2630;border-radius:12px;padding:12px;flex:1 1 320px;min-width:280px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #1f2630;vertical-align:middle;white-space:nowrap}
  th{font-weight:600;color:#c9d1d9;text-align:left}
  td.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .ok{background:rgba(46,160,67,.15);color:var(--ok);border:1px solid rgba(46,160,67,.4)}
  .bad{background:rgba(248,81,73,.12);color:var(--bad);border:1px solid rgba(248,81,73,.4)}
  .warn{background:rgba(210,153,34,.12);color:var(--warn);border:1px solid rgba(210,153,34,.4)}
  .muted{color:var(--muted)}
  .nowrap{white-space:nowrap}
  .grow{flex:1}
  footer{padding:12px 16px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>SVX Dashboard</h1>
</header>

<main>
  <div class="row">
    <section class="card grow" aria-labelledby="linky-h">
      <h2 id="linky-h" class="muted" style="margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.06em">Linky</h2>
      <div style="overflow:auto">
        <table id="linky">
          <thead>
            <tr>
              <!-- Hlavní seznam: bez sloupce „Počet“. Přejmenovaný „Začátek“ → „Hovor“. -->
              <th>Linka</th>
              <th>Stav</th>
              <th>Připojeno/Odpojeno</th>
              <th>Hovor</th>
              <th>Délka h.</th>
              <th>Posl.aktivita</th>
              <th>Skupina</th>
            </tr>
          </thead>
          <tbody id="linky-body">
            <tr><td colspan="7" class="muted">Načítám…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card" aria-labelledby="hist-h">
      <h2 id="hist-h" class="muted" style="margin:0 0 8px 0;font-size:13px;text-transform:uppercase;letter-spacing:.06em">Historie (posledních 28)</h2>
      <pre id="hist" style="margin:0;max-height:320px;overflow:auto" class="mono muted">—</pre>
    </section>
  </div>
</main>

<footer>
  <span id="status" class="muted">SSE nepřipojeno</span>
</footer>

<script>
(function(){
  // Relativní data URL fungují pod /svx/
  const STATUS_URL  = new URL('./data/status.json', location.href).href;
  const HISTORY_URL = new URL('./data/history.csv', location.href).href;
  const SSE_URL     = new URL('/sse', location.origin).href;

  const elBody  = document.getElementById('linky-body');
  const elHist  = document.getElementById('hist');
  const elStat  = document.getElementById('status');

  const fmtTime = (isoOrUnix) => {
    if (isoOrUnix == null || isoOrUnix === '') return '';
    let d;
    if (typeof isoOrUnix === 'number' || /^\d+$/.test(String(isoOrUnix))) {
      d = new Date(Number(isoOrUnix)*1000); // unix s
    } else {
      d = new Date(isoOrUnix);
      if (isNaN(d)) return String(isoOrUnix);
    }
    const pad=n=>String(n).padStart(2,'0');
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };

  const fmtDur = (sec) => {
    if (sec == null || isNaN(sec)) return '';
    sec = Math.max(0, Math.floor(sec));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    return (h>0? h+':'+String(m).padStart(2,'0') : m)+':'+String(s).padStart(2,'0');
  };

  // Vstupní JSON je tolerantně parsován (bez talk_count)
  function renderStatus(json){
    // Očekáváme tvar {nodes:{id:{...}}} nebo {list:[{...}]}
    const rows = [];
    if (json && typeof json==='object') {
      if (json.nodes && typeof json.nodes==='object') {
        for (const [id,n] of Object.entries(json.nodes)) rows.push(normalizeNode(id,n));
      } else if (Array.isArray(json.list)) {
        for (const n of json.list) rows.push(normalizeNode(n.id||n.call||n.name||'', n));
      }
    }
    if (!rows.length) {
      elBody.innerHTML = `<tr><td colspan="7" class="muted">Žádná data</td></tr>`;
      return;
    }
    // Stabilní pořadí: podle názvu linky
    rows.sort((a,b)=>a.linka.localeCompare(b.linka,'cs'));
    const tr = rows.map(r => `
      <tr>
        <td class="mono">${esc(r.linka)}</td>
        <td>${pill(r.stav)}</td>
        <td class="nowrap">${esc(r.pripojeno)}</td>
        <td class="nowrap">${esc(r.hovor)}</td>
        <td class="mono">${esc(r.delka)}</td>
        <td class="nowrap">${esc(r.posl)}</td>
        <td class="mono">${esc(r.skupina)}</td>
      </tr>`).join('');
    elBody.innerHTML = tr;
  }

  function normalizeNode(id, n){
    // Tolerantní mapování polí
    const linka   = n.linka || n.name || n.call || id || '';
    const state   = (n.state || n.status || '').toString().toLowerCase();
    const connected = !!(n.connected ?? n.online ?? n.active);
    const connTxt = connected ? 'Připojeno' : 'Odpojeno';
    const connAt  = n.connected_since || n.conn_since || n.last_conn || n.disconnected_since || null;
    const hovorStart = n.talk_start || n.start_ts || n.hovor_start || null;
    const duration   = n.talk_dur || n.duration || n.hovor_dur || null;
    const lastAct    = n.last_activity || n.last || n.last_ts || null;
    const group      = n.group || n.tg || n.room || '';

    return {
      linka: linka,
      stav: state.includes('tx') || state.includes('talk') ? 'Vysílá' :
            state.includes('rx') ? 'Poslouchá' :
            connected ? 'Online' : 'Offline',
      pripojeno: connAt ? `${connTxt} ${fmtTime(connAt)}` : connTxt,
      hovor: hovorStart ? fmtTime(hovorStart) : '',
      delka: duration ? fmtDur(Number(duration)) : '',
      posl:  lastAct ? fmtTime(lastAct) : '',
      skupina: String(group||'')
    };
  }

  function pill(txt){
    const t = (txt||'').toLowerCase();
    const cls = t.includes('vysíl') ? 'ok' : t.includes('offline')||t.includes('odpojen') ? 'bad' : t.includes('poslouch') ? 'warn' : 'ok';
    return `<span class="pill ${cls}">${esc(txt||'')}</span>`;
  }
  const esc = (s)=>String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

  // Načtení historie CSV
  async function loadHistory(){
    try{
      const u = HISTORY_URL + '?t=' + Date.now();
      const res = await fetch(u, {cache:'no-store'});
      if (!res.ok) throw new Error(res.status);
      const txt = await res.text();
      const lines = txt.split(/\r?\n/).slice(1).filter(Boolean); // přeskoč hlavičku
      elHist.textContent = lines.slice(-28).join('\n') || '—';
    }catch(e){ elHist.textContent = '—'; }
  }

  // První načtení statusu
  async function firstStatus(){
    try{
      const u = STATUS_URL + '?t=' + Date.now();
      const res = await fetch(u, {cache:'no-store'});
      if (!res.ok) throw new Error(res.status);
      const json = await res.json();
      renderStatus(json);
    }catch(e){
      elBody.innerHTML = `<tr><td colspan="7" class="muted">Status nedostupný</td></tr>`;
    }
  }

  // SSE
  function startSSE(){
    try{
      const es = new EventSource(SSE_URL);
      es.onopen = ()=> elStat.textContent = 'SSE připojeno';
      es.onerror= ()=> elStat.textContent = 'SSE chyba / odpojeno';
      es.addEventListener('status', (e)=> {
        try{ renderStatus(JSON.parse(e.data)); }catch(_){}
      });
      es.addEventListener('history', (e)=> {
        try{
          const arr = JSON.parse(e.data);
          elHist.textContent = (Array.isArray(arr) ? arr : []).join('\n') || '—';
        }catch(_){}
      });
    }catch(_){
      elStat.textContent = 'SSE nepřipojeno';
    }
  }

  // Start
  firstStatus();
  loadHistory();
  startSSE();
  // fallback aktualizace historie každých 30 s
  setInterval(loadHistory, 30000);
})();
</script>

</body>
</html>
